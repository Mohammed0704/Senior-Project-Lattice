<!DOCTYPE html>
<html>
<link rel='stylesheet' href='/static_files/main.css' />
<link rel='stylesheet' href='/static_files/portal_tag_management.css' />
 
<center>
  <head>
      <title>Tag Management Portal</title>
      <b>
          <h1 style="margin-bottom: 1.5%;">Tag Management Portal</h1>
      </b>
    </head>
    
    <body>
    <div id="outer-content-box">
      <div id="content">
        <div id="inner-content-box" class="left">
          <table id="tags-table">
            <tr id="table-header">
              <th style="width:76%; font-size: 22px;">Current Tags</th>
              <th style="width:12%; font-size: 22px;">Usages</th>
              <th style="width:12%; font-size: 22px;">Delete</th>
            </tr>
            {% if tagDict|length > 0 %}
              {% for tagKey, columnsTaggedList in tagDict.items() %}
                <tr id="{{ tagKey }}-row">
                  <td> {{ tagKey }}</td>
                  <td>
                    <center>
                      <button class="usage-button delete-button1" name="{{ tagKey }}">Usages</button>
                    </center>
                  </td>
                  <td>
                    <center>
                      <button class="delete-button delete-button1" name="{{ tagKey }}">Delete</button>
                    </center>
                  </td>
                </tr>
              {% endfor %}
            {% endif %}
            <tr id="table-footer">
              <td class="tag-input" style="width:76%; font-size: 20px;">
                <p id="result">
                </p>              
                <div id="create-div">
                  <form id="create-form">
                    <input type="text" id="Tag" name="Tag" value="" placeholder="Enter new tag name...">
                  </form>
                </div>
              </td>
              <td>
                <center>
                  <button class="usage-button delete-button1" id="create-button">Create</button>
                </center>
              </td>
              <td id="end-cell">
                <center>
                  <a href="/tags">
                    <button class="usage-button delete-button1">Update</button>
                  </a>
                </center>
              </td>
            </tr>
          </table>
        </div>
      <div id="inner-content-box" class="right" style="border:1px solid black;">
        <div id="label_text">
          Tag Usages
        </div>
        <div>
          <table id="usage-table">
            <tr id="table-header">
              <th style="width:88%; font-size: 20px;">Database.Schema.Table.ColumnName</th>
            </tr>
            {% if tagDict|length > 0 %}
              {% for tagKey, columnsTaggedList in tagDict.items() %}
                {% for tag in columnsTaggedList["columns_tagged"] %}
                  <tr id="{{ tagKey }}-row">
                    <td>{{ tag }}</td>
                  </tr>
                {% endfor %}
              {% endfor %}
            {% endif %}
          </table>
        </div>
      </div>
    </div>
  </body>
</center>

<script src="/static_files/jquery-3.1.1.js"></script>

<script>
  $(".delete-button").click(function(event)
  {
    elementToDeleteName = $(this).attr("name")
    if (confirm("Are you sure you want to delete this tag? This tag will also be deleted from the selected tags in the Data Object Management Portal")) {
      console.log("Deleting " + elementToDeleteName + "...");
      $("#" + elementToDeleteName.replace( /(:|\.|\[|\])/g, "\\$1" ) + "-row").remove()
  
      $.ajax({
        url: "/tags/remove/" + elementToDeleteName,
        type: "delete"
      });
    }
  });

  $(".usage-button").click(function(event)
  {
    elementToDisplayName = $(this).attr("name")

    $("#usage-table").find("tr").css("display", "none");
    $("#usage-table").find("tr[id='table-header']").css("display", "table-row");
    $("#usage-table").find("tr[id='"+elementToDisplayName+"-row']").css("display", "table-row");
  });

  const form = document.querySelector('#create-form');
  const createButton = document.querySelector('#create-button');
  const result = document.querySelector('#result');
 
  createButton.addEventListener('click', function() {
    const tag = form.elements.Tag.value;
    if (tag.includes(' ') || tag == "") {
      result.innerHTML = `<p id="error-message">Cannot have spaces in the tag name</p>`;
      return;
    }
    const tag_dict = JSON.stringify({'tag_name': tag});
 
    fetch('/tags/create/create-tag', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: tag_dict
    })
    .then(response => response.json())
    .then(data => {
      console.log(data);
      if (data.success) {
        result.innerHTML = `<p id="success-message">Tag "${tag}" was added</p>`;
        form.elements.Tag.value = "";
      } else {
        result.innerHTML = `<p id="error-message">Tag "${tag}" already exists</p>`;
      }
    });
  });
</script>


</html>